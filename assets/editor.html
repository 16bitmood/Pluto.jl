<!DOCTYPE html>
<html lang="en">

<head>
	<meta name="viewport" content="width=device-width, user-scalable=no" />
	<title>âš¡ Saturn.jl âš¡</title>
	<meta charset="utf-8" />
	<script>
		console.log("Saturn.jl, by Fons van der Plas (https://github.com/fonsp) and MikoÅ‚aj Bochenski (https://github.com/malyvsen) ðŸŒˆ");
	</script>
	<meta name="author" content="Fons van der Plas; MikoÅ‚aj Bochenski" />
	<link rel="license" href="https://github.com/fonsp/Saturn.jl/blob/master/LICENSE" />
	<meta name="theme-color" content="#000000" />
	<meta name="description" content="Saturn.jl notebook" />
	<link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,400i&display=swap&subset=cyrillic,cyrillic-ext,greek,greek-ext,latin-ext,vietnamese" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700&display=swap" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Roboto+Slab:100,200,300,400,500,600,700,800,900&display=swap&subset=cyrillic,cyrillic-ext,greek,greek-ext,latin-ext,vietnamese" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Merriweather:300,300i,400,400i,700,700i,900,900i&display=swap&subset=cyrillic,cyrillic-ext,latin-ext,vietnamese" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i&display=swap&subset=cyrillic,cyrillic-ext,greek,greek-ext,latin-ext,vietnamese" rel="stylesheet">


	<style>
		/* GENERAL PAGE LAYOUT */

		body {
			/* background-color: #ffffff; */
			margin: 0px;
			font-family: 'Open Sans', serif;
			font-weight: 400;
			color: #222;
		}

		body.swoosh{
			animation: ðŸŒˆ 30s linear 0s infinite;

		}

		h1,
		h2,
		h3,
		h4,
		h5,
		h6 {
			font-family: 'Roboto Slab', serif;
		}

		h1 {
			font-size: 2.2em;
			margin-block-start: 1em;
			margin-block-end: 0em;
			border-bottom: 3px solid rgba(0, 0, 0, .15);
		}

		h2 {
			font-size: 1.8em;
			margin-block-start: 1em;
			margin-block-end: 0em;
			border-bottom: 2px dotted rgba(0, 0, 0, .15);
		}

		h3 {
			font-size: 1.6em;
			margin-block-start: 1em;
			margin-block-end: 0em;
			/* border-bottom: 2px dotted rgba(0,0,0,.15); */
		}

		h4 {
			font-size: 1.4em;
			margin-block-start: 1em;
			margin-block-end: 0em;
		}

		h5 {
			font-size: 1.2em;
			margin-block-start: 1em;
			margin-block-end: 0em;
		}

		h6 {
			font-size: 1em;
			margin-block-start: 1em;
			margin-block-end: 0em;
		}

		p {
			margin-block-start: .5em;
		}

		html,
		body {
			height: 100%;
		}

		main {
			min-height: calc(100% - 73px - 60px);
		}

		main {
			margin: 0 auto;
			max-width: 960px;
			align-content: center;
		}

		#logje {
			text-align: left;
			font-family: monospace;
		}

		#logje p::before {
			content: "> ";
			opacity: .5;
		}

		/* HEADER */

		header {
			letter-spacing: 2px;
			background: hsla(0,100%,100%,80%);
			width: 100%;
			height: 70px;
			overflow: hidden;
			color: black;
			/* white-space: nowrap; */
			/*font-weight: normal;*/
			font-family: 'Ubuntu Mono', monospace;
			border-bottom: solid 3px #000000;
		}

		#logocontainer {
			margin: 0 auto;
			max-width: 960px;
			padding-top: 14px;
			padding-left: 20px;
			padding-bottom: 0px;
		}

		#logocontainer img {
			margin-bottom: -9px;
			margin-right: 15px;
			filter: invert(100%);
			-webkit-filter: invert(100%);
			/* Alttext: */
			color: black;
			/* should be black beacuse we are reversing its color */
			font-family: 'Courgette', sans-serif;
			font-weight: bold !important;
			font-style: normal;
		}

		#logocontainer h1 {
			font-weight: 700;
			font-size: 30px;
			display: inline;
			border-bottom: none;
		}

		#logocontainer h2 {
			display: inline;
			border-bottom: none;
		}

		#logocontainer h1>span {
			font-weight: 400;
		}

		#printernametitle {
			opacity: .6;
			font-style: normal;
			font-size: 25px;
		}

		header.disconnected {
			background-color: rgba(255, 100, 0, .3);
		}

		.disconnected>#logocontainer:after {
			content: "NOT CONNECTED";
			text-align: right;
			float: right;
			padding: 12px;
		}

		/* MAIN */

		cell {
			display: block;
			margin-bottom: 20px;
			box-shadow: 0px 0px 12px -6px rgba(0, 0, 0, 0.2);
		}

		celloutput {
			background-color: white;
			display: block;
			padding-left: 10px;
			padding-right: 10px;
			overflow: scroll;
			/*are we sure? people might write very long documents*/
			max-height: 200vh;
			border: 1px solid rgba(0, 0, 0, .1);
			border-top-left-radius: 6px;
			border-top-right-radius: 6px;
		}

		code {
			font-family: 'Roboto Mono', monospace;
			font-size: 12px;
		}

		.CodeMirror {
			height: auto !important;
			width: 100%;
			font-family: 'Roboto Mono', monospace !important;
			font-size: 14px;
			border: 6px solid pink;
			border-bottom-left-radius: 6px;
			border-bottom-right-radius: 6px;
			z-index: 2;
		}

		.CodeMirror-scroll {
			min-height: 0px;
		}

		footer {
			width: 100%;
			height: 30px;
			font-family: monospace;
			margin-top: 30px;
		}

		footer a {
			color: black;
			opacity: .6;
			font-weight: 700;
			;
		}

		#info {
			max-width: 9400px;
			margin: 0 auto;
			text-align: right;
			padding: 5px;
		}

		@keyframes ðŸŒˆ {
		from {
			background-color: hsl(0, 100%, 98%);
		}
		10% {
			background-color: hsl(90, 100%, 98%);
		}
		50% {
			background-color: hsl(180, 100%, 98%);
		}
		75% {
			background-color: hsl(270, 100%, 98%);
		}
		100% {
			background-color: hsl(360, 100%, 98%);
		}
		}

		/*.CodeMirror-linenumber {
			font-family: 'Courgette';
		}*/
	</style>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.52.0/codemirror.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.52.0/theme/lucario.min.css" />

	<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.52.0/codemirror.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.52.0/mode/julia/julia.min.js"></script>
</head>

<body>
	<header>
		<div id="logocontainer">
			<h1>
				SATURN<span>.jl</span></h1>
			<h2>
				<span id="printernametitle">/editor</span></h2>
		</div>
	</header>

	<main>
		<br>
		<br>
		<template id="celltemplate">
			<cell>
				<celloutput></celloutput>
				<cellinput></cellinput>
			</cell>
		</template>
		<notebook>
		</notebook>
	</main>

	<footer>
		<div id="info">
			<a href="https://github.com/fonsp/Saturn.jl">Saturn.jl</a>, by <a href="https://github.com/fonsp" rel="author">fonsp</a> and <a href="https://github.com/malyvsen" rel="author">malyvsen</a>
		</div>
	</footer>

	<script>
		document.addEventListener("DOMContentLoaded", function () {


			var channelName = "UNKNOWN";
			var givenUrl = new URL(document.location);
			if (givenUrl.pathname.startsWith("/view")) {
				document.location = "/view?" + givenUrl.pathname.substring(6)
			}
			if (givenUrl.search == "") {
				channelName = givenUrl.pathname.substring(1)
			} else {
				channelName = givenUrl.search.substring(1);
			}
			channelName = "test_notebook.jl"
			document.querySelector("#printernametitle").innerText = "/" + channelName;



			window.cells = {}
			window.codeMirrors = {}

			function createCodeMirrorInsideCell(cellNode, code) {
				var editor = CodeMirror((elt) => {
					cellNode.querySelector("cellinput").appendChild(elt)
				}, {
					value: code,
					lineNumbers: true,
					mode: "julia",
					lineWrapping: true,
					lineNumberFormatter: function (i) {
						return "â‹…"
					},
					theme: "lucario",
					viewportMargin: Infinity,
				});

				window.codeMirrors[cellNode.id] = editor
				//editor.setOption("readOnly", true);

				editor.setOption("extraKeys", {
					"Ctrl-Enter": () => changeCell(cellNode.id)
				});
			}

			function updateCellOutput(cellNode, mime, output) {
				console.log(mime)
				if (mime == "text/html") {
					// from https://stackoverflow.com/a/26716182

					cellNode.querySelector("celloutput").innerHTML = output

					// to execute all scripts in the html:

					try {
						var scripts = Array.prototype.slice.call(cellNode.querySelector("celloutput").getElementsByTagName("script"))
						for (var i = 0; i < scripts.length; i++) {
							if (scripts[i].src != "") {
								if(!Array.prototype.map.call(document.head.querySelectorAll("script"), s=>s.src).includes(scripts[i]))
								{
									var tag = document.createElement("script")
									tag.src = scripts[i].src
									document.head.appendChild(tag)
								}
							}
							else {
								eval(scripts[i].innerHTML)
							}
						}
					} catch (err) {
						console.log("Couldn't execute all scripts:")
						console.log(err)
						// TODO: relay to user
						// might be wise to wait after adding scripts to head
						//
					}
				} else {
					cellNode.querySelector("celloutput").innerHTML = "<pre><code></code></pre>"
					cellNode.querySelector("celloutput").querySelector("code").innerText = output
				}
			}

			cellTemplate = document.querySelector("#celltemplate").content.firstElementChild
			notebookNode = document.querySelector("notebook")
			window.notebookNode = notebookNode

			function createCell(newIndex, uuid, code) {
				var newCellNode = cellTemplate.cloneNode(true)
				newCellNode.id = uuid

				window.cells[uuid] = newCellNode


				if (notebookNode.children.length == newIndex) {
					notebookNode.appendChild(newCellNode)
				} else if (notebookNode.children.length > newIndex) {
					notebookNode.insertBefore(newCellNode, notebookNode.children[newIndex])
				} else {
					console.error("Tried to insert cell at illegal position! Notebook order might be messed up!")
					notebookNode.appendChild(newCellNode)
				}

				createCodeMirrorInsideCell(newCellNode, code)
				//updateCellOutput(newCellNode, mime, output)
			}

			function deleteCell(cellNode) {
				// TODO: event listeners? gc?
				uuid = cellNode.id
				try {
					delete window.codeMirrors[uuid]
				} catch (err) { }
				try {
					delete window.cells[uuid]
				} catch (err) { }

				cellNode.remove()
			}

			function deleteAllCells() {
				for (var uuid in window.cells) {
					deleteCell(window.cells[uuid])
				}
			}

			if ("fonts" in document) {
				document.fonts.ready.then(function () {
					console.log("fonts loaded");
					for (var uuid in window.codeMirrors) {
						window.codeMirrors[uuid].refresh()
					}
				});
			}

			// This is kind of overkill
			function ping(onSucces, onFailure) {
				fetch("/ping", {
					method: 'GET',
					cache: 'no-cache',
					headers: {
						'Content-Type': 'application/json',
					},
					redirect: 'follow',
					referrerPolicy: 'no-referrer',
					//body: "hiiiii"
				}).then((response) => {
					return response.json()
				}).then((response) => {
					if (response == "OK!") {
						onSucces(response)
					} else {
						onFailure(response)
					}
				}).catch(onFailure)
			}
			ping(console.log, console.warn)


			function reloadAllCells(onFailure, onSucces) {
				ping(() => {
					// We have a connection!

					fetch("/getallcells", {
						method: 'GET',
						cache: 'no-cache',
						headers: {
							'Content-Type': 'application/json',
						},
						redirect: 'follow',
						referrerPolicy: 'no-referrer',
						//body: "hiiiii"
					}).then((response) => {
						return response.json()
					}).then((remoteCells) => {
						console.log("Remote cells loaded")
						console.log(remoteCells)

						for (var cellIndex in remoteCells) {
							remoteCell = remoteCells[cellIndex]
							//createCell(cellIndex, remoteCell.uuid, remoteCell.code, remoteCell.output)
							// createCell(cellIndex, remoteCell.uuid, remoteCell.code, remoteCell.code)
							createCell(cellIndex, remoteCell.uuid, remoteCell.code)
						}

						onSucces()
					}).catch(onFailure)
				}, console.warn)
			}

			function changeCell(uuid) {
				var onFailure = (response) => {
					console.warn("Failed to update cell!")
					console.log(response)

					document.querySelector("header").classList.add("disconnected")

					setTimeout(() => {
						ping(() => {
							document.querySelector("header").classList.remove("disconnected")
						}, onFailure)
					}, 1000)
				}
				newCode = window.codeMirrors[uuid].getValue()
				fetch("/changecell", {
					method: 'PUT',
					cache: 'no-cache',
					headers: {
						'Content-Type': 'application/json'
					},
					redirect: 'follow',
					referrerPolicy: 'no-referrer',
					body: JSON.stringify({ "uuid": uuid, "code": newCode }),
				}).then((response) => {
					if (response.status == 200) {
						console.log("Cell updated.")
					} else {
						onFailure(response)
					}
				}).catch(onFailure)
			}

			function runUpdateLoop() {
				console.log("run update loop")
				var onFailure = (response) => {
					console.warn("Failed to get updates!")
					console.log(response)

					document.querySelector("header").classList.add("disconnected")


					setTimeout(() => {
						ping(() => {
							document.querySelector("header").classList.remove("disconnected")
							runUpdateLoop()
						}, onFailure)
					}, 1000)
				}

				fetch("/nextcellupdate", {
					method: 'GET',
					cache: 'no-cache',
					redirect: 'follow',
					referrerPolicy: 'no-referrer',
				}).then((response) => {
					console.log("update response received")
					console.log(response)
					if (response.status == 200) {
						response.json().then((update) => {
							// UPDATE RECEIVED
							console.log("output deserialized")
							console.log(update)
							updateCellOutput(window.cells[update.uuid], update.mime, update.output)
							//TODO: animation âœ¨

							runUpdateLoop()
						})
					} else if (response.status == 204) {
						runUpdateLoop()
					} else {
						onFailure(response)
					}
				}).catch(onFailure)
			}


			reloadAllCells(console.warn, runUpdateLoop)

			// TODO: reconnect with a delay if the last request went poorly
			// this would avoid hanging UI when the connection is lost maybe?
			// implemented, but untested

			// TODO: check cell order every now and then?
			// or do ___maths___ to make sure that it never gets messed up




			window.reloadAllCells = reloadAllCells
			window.ping = ping
			//editor.on("change", window.preview);

		});
	</script>
	<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/dot/1.1.3/doT.min.js" integrity="sha256-0Mj4wysSsxKrjqVsgnOgOeRZbPreFi/T3+zb+cyR7Jw=" crossorigin="anonymous"></script>-->
</body>

</html>